suite: test additionalTlsSecrets feature
templates:
  - statefulset.yaml
values:
  - ../tests/test-values.yaml
tests:
  - it: should not mount additional TLS secrets when list is empty
    set:
      statefulset.enabled: true
      additionalTlsSecrets: []
      replicaCount: 1
      image:
        repository: "test/app"
        tag: "v1.0.0"
      service:
        port: 80
      applicationPort: 8080
      useTLS: false
      persistentVolumeClaims:
        enabled: false
      processExporter:
        enabled: false
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: StatefulSet
      # Should pass since there are no additional TLS secrets to mount
      - exists:
          path: spec.template.spec

  - it: should not mount additional TLS secrets when not specified
    set:
      statefulset.enabled: true
      replicaCount: 1
      image:
        repository: "test/app"
        tag: "v1.0.0"
      service:
        port: 80
      applicationPort: 8080
      useTLS: false
      persistentVolumeClaims:
        enabled: false
      processExporter:
        enabled: false
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: StatefulSet
      # Should pass since there are no additional TLS secrets to mount
      - exists:
          path: spec.template.spec

  - it: should mount single additional TLS secret
    set:
      statefulset.enabled: true
      additionalTlsSecrets:
        - "client-cert-secret"
      replicaCount: 1
      image:
        repository: "test/app"
        tag: "v1.0.0"
      service:
        port: 80
      applicationPort: 8080
      useTLS: false
      persistentVolumeClaims:
        enabled: false
      processExporter:
        enabled: false
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: StatefulSet
      # Main container should have additional TLS volume mount
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: "additional-tls-client-cert-secret"
            mountPath: "/etc/ssl/client-cert-secret"
            readOnly: true
      # Should have additional TLS volume defined
      - contains:
          path: spec.template.spec.volumes
          content:
            name: "additional-tls-client-cert-secret"
            secret:
              secretName: "client-cert-secret"
              optional: true

  - it: should mount multiple additional TLS secrets
    set:
      statefulset.enabled: true
      additionalTlsSecrets:
        - "client-cert-secret"
        - "ca-bundle-secret"
        - "custom-tls-secret"
      replicaCount: 1
      image:
        repository: "test/app"
        tag: "v1.0.0"
      service:
        port: 80
      applicationPort: 8080
      useTLS: false
      persistentVolumeClaims:
        enabled: false
      processExporter:
        enabled: false
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: StatefulSet
      # Main container should have all additional TLS volume mounts
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: "additional-tls-client-cert-secret"
            mountPath: "/etc/ssl/client-cert-secret"
            readOnly: true
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: "additional-tls-ca-bundle-secret"
            mountPath: "/etc/ssl/ca-bundle-secret"
            readOnly: true
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: "additional-tls-custom-tls-secret"
            mountPath: "/etc/ssl/custom-tls-secret"
            readOnly: true
      # Should have all additional TLS volumes defined
      - contains:
          path: spec.template.spec.volumes
          content:
            name: "additional-tls-client-cert-secret"
            secret:
              secretName: "client-cert-secret"
              optional: true
      - contains:
          path: spec.template.spec.volumes
          content:
            name: "additional-tls-ca-bundle-secret"
            secret:
              secretName: "ca-bundle-secret"
              optional: true
      - contains:
          path: spec.template.spec.volumes
          content:
            name: "additional-tls-custom-tls-secret"
            secret:
              secretName: "custom-tls-secret"
              optional: true

  - it: should mount additional TLS secrets in process-exporter when enabled
    set:
      statefulset.enabled: true
      additionalTlsSecrets:
        - "client-cert-secret"
        - "ca-bundle-secret"
      replicaCount: 1
      image:
        repository: "test/app"
        tag: "v1.0.0"
      service:
        port: 80
      applicationPort: 8080
      useTLS: false
      persistentVolumeClaims:
        enabled: false
      processExporter:
        enabled: true
        port: 9256
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: StatefulSet
      # Process-exporter container should have additional TLS volume mounts
      - contains:
          path: spec.template.spec.containers[1].volumeMounts
          content:
            name: "additional-tls-client-cert-secret"
            mountPath: "/etc/ssl/client-cert-secret"
            readOnly: true
      - contains:
          path: spec.template.spec.containers[1].volumeMounts
          content:
            name: "additional-tls-ca-bundle-secret"
            mountPath: "/etc/ssl/ca-bundle-secret"
            readOnly: true

  - it: should work with special characters in secret names
    set:
      statefulset.enabled: true
      additionalTlsSecrets:
        - "my-app-client-cert"
        - "api-server-ca-bundle"
      replicaCount: 1
      image:
        repository: "test/app"
        tag: "v1.0.0"
      service:
        port: 80
      applicationPort: 8080
      useTLS: false
      persistentVolumeClaims:
        enabled: false
      processExporter:
        enabled: false
    asserts:
      - hasDocuments:
          count: 1
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: "additional-tls-my-app-client-cert"
            mountPath: "/etc/ssl/my-app-client-cert"
            readOnly: true
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: "additional-tls-api-server-ca-bundle"
            mountPath: "/etc/ssl/api-server-ca-bundle"
            readOnly: true

  - it: should work alongside existing TLS certificate mount
    set:
      statefulset.enabled: true
      useTLS: true
      additionalTlsSecrets:
        - "client-cert-secret"
      certificate:
        secretName: "platform-tls-secret"
      replicaCount: 1
      image:
        repository: "test/app"
        tag: "v1.0.0"
      service:
        port: 80
      applicationPort: 8080
      persistentVolumeClaims:
        enabled: false
      processExporter:
        enabled: false
    asserts:
      - hasDocuments:
          count: 1
      # Should have both platform TLS and additional TLS mounts
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: "platform-cert-volume"
            mountPath: "/etc/ssl/platform"
            readOnly: true
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: "additional-tls-client-cert-secret"
            mountPath: "/etc/ssl/client-cert-secret"
            readOnly: true
      # Should have both platform TLS and additional TLS volumes
      - contains:
          path: spec.template.spec.volumes
          content:
            name: "platform-cert-volume"
            secret:
              secretName: "platform-tls-secret"
      - contains:
          path: spec.template.spec.volumes
          content:
            name: "additional-tls-client-cert-secret"
            secret:
              secretName: "client-cert-secret"
              optional: true

  - it: should have optional secret volumes
    set:
      statefulset.enabled: true
      additionalTlsSecrets:
        - "optional-cert-secret"
      replicaCount: 1
      image:
        repository: "test/app"
        tag: "v1.0.0"
      service:
        port: 80
      applicationPort: 8080
      useTLS: false
      persistentVolumeClaims:
        enabled: false
      processExporter:
        enabled: false
    asserts:
      - hasDocuments:
          count: 1
      # Volume should be marked as optional
      - contains:
          path: spec.template.spec.volumes
          content:
            name: "additional-tls-optional-cert-secret"
            secret:
              secretName: "optional-cert-secret"
              optional: true

  - it: should work with persistence enabled
    set:
      statefulset.enabled: true
      additionalTlsSecrets:
        - "client-cert-secret"
      mountAdapterVolume: true
      mountLogVolume: true
      replicaCount: 1
      image:
        repository: "test/app"
        tag: "v1.0.0"
      service:
        port: 80
      applicationPort: 8080
      useTLS: false
      persistentVolumeClaims:
        enabled: true
      processExporter:
        enabled: false
    asserts:
      - hasDocuments:
          count: 1
      # Should have both persistent volume and additional TLS mounts
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: RELEASE-NAME-iap-assets-volume
            mountPath: "/opt/itential/platform/services/custom"
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: RELEASE-NAME-iap-logs-volume
            mountPath: "/var/log/itential"
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: "additional-tls-client-cert-secret"
            mountPath: "/etc/ssl/client-cert-secret"
            readOnly: true