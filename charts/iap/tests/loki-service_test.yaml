suite: test loki service template
templates:
  - loki-service.yaml
values:
  - ../tests/test-values.yaml
tests:
  - it: should not render Loki service when disabled
    set:
      loki:
        enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should render Loki service when enabled with defaults
    set:
      loki:
        enabled: true
        httpPort: 3100
        grpcPort: 9095
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Service
      - isAPIVersion:
          of: v1
      - equal:
          path: metadata.name
          value: "RELEASE-NAME-iap-loki"

  - it: should have correct labels in metadata
    set:
      loki:
        enabled: true
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/component"]
          value: "loki"
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: "RELEASE-NAME"
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: "iap"
      - equal:
          path: metadata.labels["app.kubernetes.io/part-of"]
          value: "itential-platform"
      - exists:
          path: metadata.labels["app.kubernetes.io/version"]
      - exists:
          path: metadata.labels["helm.sh/chart"]

  - it: should have correct annotations
    set:
      loki:
        enabled: true
    asserts:
      - equal:
          path: metadata.annotations["kubernetes.io/description"]
          value: "Loki service for log aggregation."
      - exists:
          path: metadata.annotations["itential.com/copyright"]
      - exists:
          path: metadata.annotations["itential.com/license"]
      - exists:
          path: metadata.annotations["helm.sh/template-file"]

  - it: should have correct selector labels
    set:
      loki:
        enabled: true
    asserts:
      - isSubset:
          path: spec.selector
          content:
            app.kubernetes.io/name: "iap"
            app.kubernetes.io/instance: "RELEASE-NAME"
            app.kubernetes.io/component: "loki"

  - it: should configure default ports
    set:
      loki:
        enabled: true
        httpPort: 3100
        grpcPort: 9095
    asserts:
      - lengthEqual:
          path: spec.ports
          count: 2
      - contains:
          path: spec.ports
          content:
            name: http
            port: 3100
            targetPort: http
            protocol: TCP
      - contains:
          path: spec.ports
          content:
            name: grpc
            port: 9095
            targetPort: grpc
            protocol: TCP

  - it: should configure custom ports
    set:
      loki:
        enabled: true
        httpPort: 8080
        grpcPort: 8081
    asserts:
      - contains:
          path: spec.ports
          content:
            name: http
            port: 8080
            targetPort: http
            protocol: TCP
      - contains:
          path: spec.ports
          content:
            name: grpc
            port: 8081
            targetPort: grpc
            protocol: TCP

  - it: should have ClusterIP service type
    set:
      loki:
        enabled: true
    asserts:
      - equal:
          path: spec.type
          value: "ClusterIP"

  - it: should work with different release names
    set:
      loki:
        enabled: true
    release:
      name: "custom-release"
    asserts:
      - equal:
          path: metadata.name
          value: "custom-release-iap-loki"
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: "custom-release"
      - isSubset:
          path: spec.selector
          content:
            app.kubernetes.io/instance: "custom-release"

  - it: should handle nameOverride
    set:
      loki:
        enabled: true
      nameOverride: "custom-name"
    asserts:
      - equal:
          path: metadata.name
          value: "RELEASE-NAME-custom-name-loki"
      - isSubset:
          path: spec.selector
          content:
            app.kubernetes.io/name: "custom-name"

  - it: should validate port structure
    set:
      loki:
        enabled: true
        httpPort: 3100
        grpcPort: 9095
    asserts:
      - exists:
          path: spec.ports
      - exists:
          path: spec.ports[0].name
      - exists:
          path: spec.ports[0].port
      - exists:
          path: spec.ports[0].targetPort
      - exists:
          path: spec.ports[0].protocol
      - exists:
          path: spec.ports[1].name
      - exists:
          path: spec.ports[1].port
      - exists:
          path: spec.ports[1].targetPort
      - exists:
          path: spec.ports[1].protocol

  - it: should always use TCP protocol
    set:
      loki:
        enabled: true
        httpPort: 3100
        grpcPort: 9095
    asserts:
      - equal:
          path: spec.ports[0].protocol
          value: "TCP"
      - equal:
          path: spec.ports[1].protocol
          value: "TCP"

  - it: should handle standard HTTP port
    set:
      loki:
        enabled: true
        httpPort: 80
        grpcPort: 9095
    asserts:
      - contains:
          path: spec.ports
          content:
            name: http
            port: 80
            targetPort: http
            protocol: TCP

  - it: should handle high port numbers
    set:
      loki:
        enabled: true
        httpPort: 32000
        grpcPort: 31000
    asserts:
      - contains:
          path: spec.ports
          content:
            name: http
            port: 32000
            targetPort: http
            protocol: TCP
      - contains:
          path: spec.ports
          content:
            name: grpc
            port: 31000
            targetPort: grpc
            protocol: TCP

  - it: should handle same HTTP and GRPC ports
    set:
      loki:
        enabled: true
        httpPort: 3100
        grpcPort: 3100
    asserts:
      - contains:
          path: spec.ports
          content:
            name: http
            port: 3100
            targetPort: http
            protocol: TCP
      - contains:
          path: spec.ports
          content:
            name: grpc
            port: 3100
            targetPort: grpc
            protocol: TCP

  - it: should work with fullnameOverride
    set:
      loki:
        enabled: true
      fullnameOverride: "custom-loki-name"
    asserts:
      - equal:
          path: metadata.name
          value: "custom-loki-name-loki"

  - it: should validate required service fields
    set:
      loki:
        enabled: true
        httpPort: 3100
        grpcPort: 9095
    asserts:
      - exists:
          path: spec.ports
      - exists:
          path: spec.selector
      - exists:
          path: spec.type
      - exists:
          path: metadata.name
      - exists:
          path: metadata.labels

  - it: should have consistent port naming
    set:
      loki:
        enabled: true
        httpPort: 9999
        grpcPort: 8888
    asserts:
      - equal:
          path: spec.ports[0].name
          value: "http"
      - equal:
          path: spec.ports[1].name
          value: "grpc"